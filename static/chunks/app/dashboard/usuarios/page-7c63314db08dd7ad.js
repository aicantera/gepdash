(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[543],{2184:function(e,r,a){Promise.resolve().then(a.bind(a,1018))},1018:function(e,r,a){"use strict";a.r(r),a.d(r,{default:function(){return GestionUsuarios}});var t=a(7437),s=a(2265),i=a(2899);let l="usuarios";async function obtenerUsuarios(){let{data:e,error:r}=await i.O.from(l).select("*").order("created_at",{ascending:!1});if(r)throw console.error("Error al obtener usuarios:",r),r;return e||[]}async function buscarUsuarios(e){let{data:r,error:a}=await i.O.from(l).select("*").or("nombre.ilike.%".concat(e,"%,email.ilike.%").concat(e,"%,empresa.ilike.%").concat(e,"%")).order("created_at",{ascending:!1});if(a)throw console.error("Error al buscar usuarios:",a),a;return r||[]}async function obtenerUsuarioPorId(e){let{data:r,error:a}=await i.O.from(l).select("*").eq("id",e).single();if(a)throw console.error("Error al obtener usuario por ID:",a),a;return r}async function crearUsuario(e,r,a,t,s){let{data:n,error:o}=await i.p.auth.admin.createUser({email:r,password:a,email_confirm:!0});if(o)throw console.error("Error al crear usuario en Auth:",o),o;let c=n.user.id,d={auth_id:c,nombre:e,email:r,rol:t,empresa:s||null,created_at:new Date().toISOString(),updated_at:new Date().toISOString()},{data:u,error:m}=await i.p.from(l).insert([d]).select().single();if(m)throw console.error("Error al crear usuario en la tabla:",m),await i.p.auth.admin.deleteUser(c),m;return u}async function actualizarUsuario(e,r){let a=await obtenerUsuarioPorId(e);if(!a)throw Error("Usuario no encontrado");if(r.email&&r.email!==a.email){let{error:e}=await i.p.auth.admin.updateUserById(a.auth_id,{email:r.email});if(e)throw console.error("Error al actualizar email en Auth:",e),e}let t={...r,updated_at:new Date().toISOString()},{data:s,error:n}=await i.p.from(l).update(t).eq("id",e).select().single();if(n)throw console.error("Error al actualizar usuario en la tabla:",n),n;return s}async function eliminarUsuario(e){let r=await obtenerUsuarioPorId(e);if(!r)throw Error("Usuario no encontrado");let{error:a}=await i.p.from(l).delete().eq("id",e);if(a)throw console.error("Error al eliminar usuario de la tabla:",a),a;let{error:t}=await i.p.auth.admin.deleteUser(r.auth_id);if(t)throw console.error("Error al eliminar usuario de Auth:",t),t}var n=a(3159);function TablaUsuarios(e){let{usuarios:r,onEdit:a,onRefresh:i}=e,[l,o]=(0,s.useState)(null),[c,d]=(0,s.useState)(!1),[u,m]=(0,s.useState)(null),handleDelete=async e=>{if(l!==e){o(e);return}d(!0),m(null);try{await eliminarUsuario(e),i()}catch(e){m(e.message||"Error al eliminar usuario")}finally{d(!1),o(null)}},cancelDelete=()=>{o(null)};return(0,t.jsxs)("div",{className:"bg-white shadow-md rounded-lg overflow-hidden",children:[u&&(0,t.jsx)("div",{className:"bg-red-50 border-l-4 border-red-500 p-4 m-4",children:(0,t.jsx)("div",{className:"flex",children:(0,t.jsx)("div",{className:"ml-3",children:(0,t.jsx)("p",{className:"text-sm text-red-700",children:u})})})}),(0,t.jsx)("div",{className:"overflow-x-auto",children:(0,t.jsxs)("table",{className:"min-w-full divide-y divide-gray-200",children:[(0,t.jsx)("thead",{className:"bg-gray-50",children:(0,t.jsxs)("tr",{children:[(0,t.jsx)("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Usuario"}),(0,t.jsx)("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Email"}),(0,t.jsx)("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Rol"}),(0,t.jsx)("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Empresa"}),(0,t.jsx)("th",{scope:"col",className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Acciones"})]})}),(0,t.jsx)("tbody",{className:"bg-white divide-y divide-gray-200",children:0===r.length?(0,t.jsx)("tr",{children:(0,t.jsx)("td",{colSpan:5,className:"px-6 py-4 text-center text-sm text-gray-500",children:"No hay usuarios registrados"})}):r.map(e=>(0,t.jsxs)("tr",{className:"hover:bg-gray-50",children:[(0,t.jsx)("td",{className:"px-6 py-4 whitespace-nowrap",children:(0,t.jsxs)("div",{className:"flex items-center",children:[(0,t.jsx)("div",{className:"h-10 w-10 flex-shrink-0 bg-gray-200 rounded-full flex items-center justify-center",children:(0,t.jsx)("span",{className:"text-gray-500 font-medium",children:e.nombre.substring(0,1).toUpperCase()})}),(0,t.jsx)("div",{className:"ml-4",children:(0,t.jsx)("div",{className:"text-sm font-medium text-gray-900",children:e.nombre})})]})}),(0,t.jsx)("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:e.email}),(0,t.jsx)("td",{className:"px-6 py-4 whitespace-nowrap",children:(0,t.jsx)("span",{className:"px-2 inline-flex text-xs leading-5 font-semibold rounded-full ".concat("admin"===e.rol?"bg-green-100 text-green-800":"bg-blue-100 text-blue-800"),children:"admin"===e.rol?"Administrador":"Viewer"})}),(0,t.jsx)("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:e.empresa||"-"}),(0,t.jsx)("td",{className:"px-6 py-4 whitespace-nowrap text-right text-sm font-medium",children:(0,t.jsxs)("div",{className:"flex justify-end space-x-2",children:[(0,t.jsx)("button",{onClick:()=>a(e),className:"text-indigo-600 hover:text-indigo-900 p-1",title:"Editar usuario",children:(0,t.jsx)(n.fmQ,{})}),(0,t.jsx)("button",{onClick:()=>handleDelete(e.id),className:"p-1 ".concat(l===e.id?"text-red-600 animate-pulse":"text-gray-500 hover:text-red-600"),title:l===e.id?"Confirmar eliminaci\xf3n":"Eliminar usuario",disabled:c,children:(0,t.jsx)(n.Xm5,{})}),l===e.id&&(0,t.jsx)("button",{onClick:cancelDelete,className:"text-gray-500 hover:text-gray-700 p-1",title:"Cancelar",children:"âœ•"})]})})]},e.id))})]})})]})}function UsuarioModal(e){let{usuario:r,isOpen:a,onClose:i,onSuccess:l}=e,[n,o]=(0,s.useState)(""),[c,d]=(0,s.useState)(""),[u,m]=(0,s.useState)(""),[x,h]=(0,s.useState)("viewer"),[p,f]=(0,s.useState)(""),[g,b]=(0,s.useState)(!1),[y,w]=(0,s.useState)(null),j=!!r;(0,s.useEffect)(()=>{r?(o(r.nombre||""),d(r.email||""),m(""),h(r.rol||"viewer"),f(r.empresa||"")):(o(""),d(""),m(""),h("viewer"),f(""))},[r]);let handleSubmit=async e=>{e.preventDefault(),b(!0),w(null);try{if(j&&r)await actualizarUsuario(r.id,{nombre:n,email:c,rol:x,empresa:p||void 0});else{if(!u)throw Error("La contrase\xf1a es obligatoria para crear un usuario");await crearUsuario(n,c,u,x,p||void 0)}l(),i()}catch(e){w(e.message||"Ha ocurrido un error")}finally{b(!1)}};return a?(0,t.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:(0,t.jsxs)("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-md mx-4",children:[(0,t.jsxs)("div",{className:"flex justify-between items-center p-6 border-b",children:[(0,t.jsx)("h2",{className:"text-xl font-semibold text-gray-800",children:j?"Editar Usuario":"A\xf1adir Nuevo Usuario"}),(0,t.jsx)("button",{onClick:i,className:"text-gray-500 hover:text-gray-700",children:(0,t.jsx)("svg",{className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),y&&(0,t.jsx)("div",{className:"bg-red-50 border-l-4 border-red-500 p-4 mx-6 mt-4",children:(0,t.jsx)("div",{className:"flex",children:(0,t.jsx)("div",{className:"ml-3",children:(0,t.jsx)("p",{className:"text-sm text-red-700",children:y})})})}),(0,t.jsxs)("form",{onSubmit:handleSubmit,className:"p-6",children:[(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{htmlFor:"nombre",className:"block text-sm font-medium text-gray-700 mb-1",children:"Nombre Completo"}),(0,t.jsx)("input",{id:"nombre",type:"text",required:!0,value:n,onChange:e=>o(e.target.value),className:"input-field rounded-md shadow-sm w-full",placeholder:"Ingrese nombre completo"})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{htmlFor:"email",className:"block text-sm font-medium text-gray-700 mb-1",children:"Email"}),(0,t.jsx)("input",{id:"email",type:"email",required:!0,value:c,onChange:e=>d(e.target.value),className:"input-field rounded-md shadow-sm w-full",placeholder:"correo@ejemplo.com"})]}),!j&&(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{htmlFor:"password",className:"block text-sm font-medium text-gray-700 mb-1",children:"Contrase\xf1a"}),(0,t.jsx)("input",{id:"password",type:"password",required:!j,value:u,onChange:e=>m(e.target.value),className:"input-field rounded-md shadow-sm w-full",placeholder:"Ingrese contrase\xf1a"})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{htmlFor:"rol",className:"block text-sm font-medium text-gray-700 mb-1",children:"Rol"}),(0,t.jsxs)("select",{id:"rol",value:x,onChange:e=>h(e.target.value),className:"input-field rounded-md shadow-sm w-full",children:[(0,t.jsx)("option",{value:"viewer",children:"Viewer"}),(0,t.jsx)("option",{value:"admin",children:"Administrador"})]})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{htmlFor:"empresa",className:"block text-sm font-medium text-gray-700 mb-1",children:"Empresa"}),(0,t.jsx)("input",{id:"empresa",type:"text",value:p,onChange:e=>f(e.target.value),className:"input-field rounded-md shadow-sm w-full",placeholder:"Seleccione una empresa"})]})]}),(0,t.jsxs)("div",{className:"flex justify-end space-x-3 mt-6",children:[(0,t.jsx)("button",{type:"button",onClick:i,className:"px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50",children:"Cancelar"}),(0,t.jsx)("button",{type:"submit",disabled:g,className:"btn-primary px-4 py-2 rounded-md shadow-sm text-sm font-medium",children:g?"Procesando...":j?"Guardar Cambios":"Crear Usuario"})]})]})]})}):null}function GestionUsuarios(){let[e,r]=(0,s.useState)([]),[a,i]=(0,s.useState)(null),[l,o]=(0,s.useState)(!1),[c,d]=(0,s.useState)(!0),[u,m]=(0,s.useState)(null),[x,h]=(0,s.useState)("");(0,s.useEffect)(()=>{cargarUsuarios()},[]);let cargarUsuarios=async()=>{d(!0),m(null);try{let e=await obtenerUsuarios();r(e)}catch(e){m(e.message||"Error al cargar usuarios")}finally{d(!1)}},handleBuscar=async()=>{if(!x.trim()){cargarUsuarios();return}d(!0),m(null);try{let e=await buscarUsuarios(x);r(e)}catch(e){m(e.message||"Error al buscar usuarios")}finally{d(!1)}};return(0,t.jsxs)("div",{className:"container mx-auto px-4 py-6",children:[(0,t.jsxs)("div",{className:"mb-8",children:[(0,t.jsx)("h1",{className:"text-2xl font-bold text-gray-800 mb-2",children:"Gesti\xf3n de Usuarios"}),(0,t.jsx)("p",{className:"text-gray-600",children:"Administra usuarios, roles y permisos"})]}),u&&(0,t.jsx)("div",{className:"bg-red-50 border-l-4 border-red-500 p-4 mb-6",children:(0,t.jsx)("div",{className:"flex",children:(0,t.jsx)("div",{className:"ml-3",children:(0,t.jsx)("p",{className:"text-sm text-red-700",children:u})})})}),(0,t.jsxs)("div",{className:"bg-white rounded-lg shadow-md p-6 mb-6",children:[(0,t.jsxs)("div",{className:"flex flex-col md:flex-row justify-between items-start md:items-center mb-6",children:[(0,t.jsx)("h2",{className:"text-lg font-semibold text-gray-900 mb-4 md:mb-0",children:"Todos los Usuarios"}),(0,t.jsxs)("div",{className:"flex flex-col sm:flex-row w-full md:w-auto space-y-3 sm:space-y-0 sm:space-x-3",children:[(0,t.jsxs)("div",{className:"relative flex-grow",children:[(0,t.jsx)("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:(0,t.jsx)(n.U41,{className:"h-4 w-4 text-gray-400"})}),(0,t.jsx)("input",{type:"text",className:"input-field pl-10 pr-4 py-2 rounded-md w-full",placeholder:"Buscar por nombre, email o empresa",value:x,onChange:e=>h(e.target.value),onKeyPress:e=>{"Enter"===e.key&&handleBuscar()}})]}),(0,t.jsx)("button",{onClick:handleBuscar,className:"btn-primary py-2 px-4 rounded-md",children:"Buscar"}),(0,t.jsxs)("button",{onClick:()=>{i(null),o(!0)},className:"btn-primary py-2 px-4 rounded-md flex items-center justify-center",children:[(0,t.jsx)(n.wEH,{className:"mr-2"})," A\xf1adir Nuevo Usuario"]})]})]}),c?(0,t.jsxs)("div",{className:"text-center py-8",children:[(0,t.jsx)("div",{className:"inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-primary"}),(0,t.jsx)("p",{className:"mt-2 text-gray-500",children:"Cargando usuarios..."})]}):(0,t.jsx)(TablaUsuarios,{usuarios:e,onEdit:e=>{i(e),o(!0)},onRefresh:cargarUsuarios})]}),(0,t.jsx)(UsuarioModal,{usuario:a,isOpen:l,onClose:()=>{o(!1)},onSuccess:cargarUsuarios})]})}},2899:function(e,r,a){"use strict";a.d(r,{O:function(){return i},p:function(){return l}});var t=a(4756);let s="https://masterd.gepdigital.ai",i=(0,t.eI)(s,"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyAgCiAgICAicm9sZSI6ICJhbm9uIiwKICAgICJpc3MiOiAic3VwYWJhc2UtZGVtbyIsCiAgICAiaWF0IjogMTY0MTc2OTIwMCwKICAgICJleHAiOiAxNzk5NTM1NjAwCn0.dc_X5iR_VP_qT0zsiyj_I_OZ2T9FtRU2BBNWN8Bu4GE"),l=(0,t.eI)(s,"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyAgCiAgICAicm9sZSI6ICJzZXJ2aWNlX3JvbGUiLAogICAgImlzcyI6ICJzdXBhYmFzZS1kZW1vIiwKICAgICJpYXQiOiAxNjQxNzY5MjAwLAogICAgImV4cCI6IDE3OTk1MzU2MDAKfQ.DaYlNEoUrrEn2Ig7tqibS-PHK5vgusbcbo7X36XVt4Q")},1172:function(e,r,a){"use strict";a.d(r,{w_:function(){return GenIcon}});var t=a(2265),s={color:void 0,size:void 0,className:void 0,style:void 0,attr:void 0},i=t.createContext&&t.createContext(s),__assign=function(){return(__assign=Object.assign||function(e){for(var r,a=1,t=arguments.length;a<t;a++)for(var s in r=arguments[a])Object.prototype.hasOwnProperty.call(r,s)&&(e[s]=r[s]);return e}).apply(this,arguments)},__rest=function(e,r){var a={};for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&0>r.indexOf(t)&&(a[t]=e[t]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var s=0,t=Object.getOwnPropertySymbols(e);s<t.length;s++)0>r.indexOf(t[s])&&Object.prototype.propertyIsEnumerable.call(e,t[s])&&(a[t[s]]=e[t[s]]);return a};function Tree2Element(e){return e&&e.map(function(e,r){return t.createElement(e.tag,__assign({key:r},e.attr),Tree2Element(e.child))})}function GenIcon(e){return function(r){return t.createElement(IconBase,__assign({attr:__assign({},e.attr)},r),Tree2Element(e.child))}}function IconBase(e){var elem=function(r){var a,s=e.attr,i=e.size,l=e.title,n=__rest(e,["attr","size","title"]),o=i||r.size||"1em";return r.className&&(a=r.className),e.className&&(a=(a?a+" ":"")+e.className),t.createElement("svg",__assign({stroke:"currentColor",fill:"currentColor",strokeWidth:"0"},r.attr,s,n,{className:a,style:__assign(__assign({color:e.color||r.color},r.style),e.style),height:o,width:o,xmlns:"http://www.w3.org/2000/svg"}),l&&t.createElement("title",null,l),e.children)};return void 0!==i?t.createElement(i.Consumer,null,function(e){return elem(e)}):elem(s)}}},function(e){e.O(0,[420,36,971,472,744],function(){return e(e.s=2184)}),_N_E=e.O()}]);